# CRNN

오늘은 CRNN을 배웠다 CRNN은 말그대로 CNN 과 RNN을 합친 것으로 이미지로부터 텍스트를 추출하는 알고리즘이다.
CNN으로 얻은 특징 맵을 RNN의 입력으로 사용하기 때문에 CRNN이라 부른다. RNN은 시계열 데이터를 처리하는 기본
적인 형태이기 때문에 더욱 박절된 GRU를 이용할 수 있다.

![image](https://user-images.githubusercontent.com/115385678/214508487-f1c003f7-4232-4d29-943e-7ad93d1ffe8c.png)

## CRNN의 장단점

* 장점
  * 이미지를 시계열 처럼 다룰 수 있음
  * 이미지의 가로축으로부터 정보를 추출 할 수 있음
* 단점
  * 세로 픽셀 개수가 1개이므로 정보의 손실이 발생할 수 있음
  * 이미지 크기가 커지면 앞의 정보가 흐려져 특징을 추출하기 어려움
* 쓰이는 곳
  * 이미지로부터 텍스트를 추출할 때 사용
  * 음원의 주파수 정보를 해석할 때 사용   

## CRNN 작동원리

1. 입력이미지가
2. CNN의 입력으로 들어감
3. CNN을 통해 이미지로부터 추출된 특징은 가로 W개 세로 H개 픽셀이 있음
4. 추출된 특징을 RNN의 입력으로 사용할 수 있게 시계열 형태로 변환(가로 방향 픽셀 개수만큼 길이를 갖는 시계열 데이터라고 생각 하는 것)
5. 이미지로부터 추출된 특징의 세로 방향 픽셀의 값을 RNN층의 은닉 상태로 이용


## RNN 의 역할 

RNN 층은 각 은닉상태가 어떤 글자에 해당하는 가 분류
그러나 한 글자에 해당하는 은닉 상태는 서로 인접해 잇기 때문에 제대로 분류를 하려면 겹쳐 있는 은닉 상태를
어떻게 구분해낼지를 생각해야만 함 

## 중복 문제

글자를 표현하지 않는 픽셀은 공백 문자로 분류하고 중복을 제거하면 연속된 문자를 표현할 수 있음
hello라는 이미지가 있다 치면 hh가 h가 되고 ee가 e가 되어 최종적으로는 hello를 성공적으로 나타낼 수 있음
하지만 이런 방식으로는 하나의 문자를 여러 방법으로 표현 하게 됨 즉 e를 표현하기 위해 ee, e-, -e 세가지 모두
중복을 제거하면 e가 됨 이런 문제를 해결하는 데 <br>CTC</br> 손실을 이용

## CTC 손실

t0과 t1 두 시점으로 정답 a라는 단어를 나타낸다고 가정하면 a를 나타내는 표현으로는 aa -a a- 세가지가 있음
각 시점은 서로 영향을 주지 않기 때문에 각 시점에서 출력을 곱하는 것으로 각 경로에 대한 확률을 구할 수 있음
ex)
  * aa일 확률 : 0.4 * 0.4 = 0.16
  * a-일 확률 : 0.4 * 0.1 = 0.04
  * -a일 확률 : 0.1 * 0.4 = 0.04
가능한 모든 경로의 확률을 더해주면 우리가 원하는 단어에 대한 확률을 구할 수 있음
다시말해, 이 신경망은 0.16 + 0.04 +0.04 = 0.24(24%)의 확률로 a를 나타낸 다는 뜻
이렇게 계산한 모든 경로의 합이 바로 <br>CTC손실</br> 이다.CTC 손실이 최소화 되도록 가중치를 학습하면
정답에 대한 경로들의 확률을 최대화시키도록 신경망 학습이 가능하다.

## CRNN 모델 정의
CRNN의 CNN 부분은 ResNet을 이용 (커널 모양을 이미지에 알맞게 바꿔야 함)
최종적으로는 RNN의 입력으로 들어가야 하므로 세로 방향의 픽셀이 1개만 존재해야 한다.
합성곱층을 거칠 때 마다 세로 방향의 픽셀 수를 줄여가야함
세로 방향 픽셀이 하나만 존재하더라도 채널 방향의 정보를 사용하면 RNN의 입력으로 들어가는 벡터의 형태를
유지할 수 있고 세로방향의 픽셀은 합성곱 커널의 스트라이드를 조절 해 줄일 수 있다.(커널크기가 합성곱 마다 다를 수도 있음)
![image](https://user-images.githubusercontent.com/115385678/214510787-2a7eac1e-037e-418d-b701-2b396c0d539d.png)

CNN으로부터 얻은 특징을 그대로 GRU에 입력하기는 불가능하다 GRU는 픽셀간의 순서 정보를 학습해야 하는데 
파이토치는 이미지를 처리할 때 채널 정보가 가장 앞에 오기 때문 따라서 채널 정보와 픽셀의 순서를 먼저 바꿔줘야 한다.
GRU의 결과 얻어진 텐서는 MLP층을 통해 어떤 글자인지 분류한다.


## CRNN이 문자열을 예측하는 과정
1. CNN의 입력으로 이미지가 들어감
2. 결과로 세로픽셀이 하나인 특징맵 출력
3. 이때 가로 픽셀 하나당 채널 정보를 하나의 벡터로 묶어주고 가로 픽셀의 방향을 시계열로 취급해 GRU의 입력으로 사용할 준비
4. 앞에서 만든 시계열을 GRU의 입력으로 넣어주면
5. GRU에서 각 픽셀이 어떤 문자를 표현하는지 예측


## CRNN 모델 구성
![image](https://user-images.githubusercontent.com/115385678/214511456-04b51972-0623-4785-bc12-0c0e15dd2282.png)


## CRNN 학습 루프

![image](https://user-images.githubusercontent.com/115385678/214511735-3a4ddb70-784f-47db-aab5-0563d117031e.png)



